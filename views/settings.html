<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>系统设置 - 现代图床</title>
  <link rel="stylesheet" href="/css/style.css">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%234361ee'><path d='M4 5h13v7h2V5c0-1.1-.9-2-2-2H4c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h8v-2H4V5zm19 7v10c0 1.1-.9 2-2 2H8c-1.1 0-2-.9-2-2V12c0-1.1.9-2 2-2h13c1.1 0 2 .9 2 2zm-2 0H8v10h13V12z'/></svg>">
</head>
<body>
  <header class="header">
    <div class="container header-content">
      <a href="/" class="logo">现代图床</a>
      <nav class="nav">
        <a href="/" class="btn btn-outline">首页</a>
        <a href="/gallery" class="btn btn-outline">我的图片库</a>
        <a href="/settings" class="btn btn-primary">系统设置</a>
        <button id="toggleDarkMode" class="btn btn-outline">暗色模式</button>
        <a href="/logout" class="btn btn-outline">退出</a>
      </nav>
    </div>
  </header>

  <main class="container settings-container">
    <div class="page-header">
      <h1>系统设置</h1>
      <p class="subtitle">管理图床系统的各项配置</p>
    </div>

    <div class="settings-layout">
      <!-- 侧边栏导航 -->
      <aside class="settings-sidebar">
        <nav class="settings-nav">
          <a href="#image-quality" class="nav-item active" data-section="image-quality">
            <span class="nav-icon">🎨</span>
            图片质量设置
          </a>
          <a href="#api-management" class="nav-item" data-section="api-management">
            <span class="nav-icon">🔧</span>
            API管理
          </a>
          <a href="#storage-config" class="nav-item" data-section="storage-config">
            <span class="nav-icon">💾</span>
            存储配置
          </a>
        </nav>
      </aside>

      <!-- 主要内容区域 -->
      <div class="settings-content">
        <!-- 图片质量设置 -->
        <section id="image-quality-section" class="settings-section active">
          <div class="section-header">
            <h2>图片质量设置</h2>
            <p class="section-description">配置图片格式转换时的质量参数，影响文件大小和图片质量</p>
          </div>

          <div class="config-content">
            <form id="qualitySettingsForm">
              <!-- WebP质量设置 -->
              <div class="form-group">
                <label for="webpQuality" class="form-label">
                  WebP 质量
                  <span class="quality-value" id="webpQualityValue">80</span>%
                </label>
                <div class="quality-control">
                  <input type="range" id="webpQuality" name="webpQuality" min="10" max="100" value="80" class="quality-slider">
                  <div class="quality-info">
                    <span class="quality-desc" id="webpQualityDesc">高质量</span>
                    <small class="quality-hint">推荐: 80-90（平衡质量与文件大小）</small>
                  </div>
                </div>
              </div>

              <!-- AVIF质量设置 -->
              <div class="form-group">
                <label for="avifQuality" class="form-label">
                  AVIF 质量
                  <span class="quality-value" id="avifQualityValue">75</span>%
                </label>
                <div class="quality-control">
                  <input type="range" id="avifQuality" name="avifQuality" min="10" max="100" value="75" class="quality-slider">
                  <div class="quality-info">
                    <span class="quality-desc" id="avifQualityDesc">高质量</span>
                    <small class="quality-hint">推荐: 70-80（AVIF压缩效率更高）</small>
                  </div>
                </div>
              </div>

              <!-- PNG优化设置 -->
              <div class="form-group">
                <label for="pngOptimize" class="form-label">PNG 优化</label>
                <div class="checkbox-group">
                  <label class="checkbox-label">
                    <input type="checkbox" id="pngOptimize" name="pngOptimize" checked>
                    <span class="checkmark"></span>
                    启用PNG压缩优化（减小文件大小，不影响质量）
                  </label>
                </div>
              </div>

              <div class="action-buttons">
                <button type="button" id="resetDefaults" class="btn btn-secondary">恢复默认</button>
                <button type="submit" class="btn btn-primary">保存设置</button>
              </div>
            </form>
          </div>

          <!-- 预设质量模板 -->
          <div class="section-header">
            <h3>质量预设</h3>
            <p class="section-description">快速应用预定义的质量配置</p>
          </div>

          <div class="config-content">
            <div class="preset-grid">
              <div class="preset-card" data-preset="high">
                <h4>高质量</h4>
                <p class="preset-desc">WebP: 92%, AVIF: 85%</p>
                <p class="preset-usage">适合：摄影作品、重要图片</p>
                <button class="btn btn-outline preset-btn">应用</button>
              </div>
              
              <div class="preset-card" data-preset="balanced">
                <h4>平衡模式</h4>
                <p class="preset-desc">WebP: 80%, AVIF: 75%</p>
                <p class="preset-usage">适合：日常使用、网站图片</p>
                <button class="btn btn-outline preset-btn">应用</button>
              </div>
              
              <div class="preset-card" data-preset="compressed">
                <h4>高压缩</h4>
                <p class="preset-desc">WebP: 65%, AVIF: 60%</p>
                <p class="preset-usage">适合：缩略图、大批量处理</p>
                <button class="btn btn-outline preset-btn">应用</button>
              </div>
            </div>
          </div>
        </section>

        <!-- API管理部分 -->
        <section id="api-management-section" class="settings-section">
          <div class="section-header">
            <h2>API管理</h2>
            <p class="section-description">管理API令牌和设置，方便与第三方工具集成</p>
          </div>

          <div class="settings-row">
            <div class="settings-col-main">
              <!-- API状态设置 -->
              <div class="config-section">
                <div class="config-header">
                  <h3>API状态</h3>
                </div>
                <div class="config-content">
                  <div class="api-switch">
                    <input class="form-check-input" type="checkbox" id="apiEnabledSwitch">
                    <label class="form-check-label" for="apiEnabledSwitch">启用API</label>
                  </div>
                  
                  <div id="apiDisabledWarning" style="display: none;" class="alert alert-warning">
                    API功能当前已禁用，即使有有效的令牌也无法访问API。
                  </div>

                  <div class="format-radio-group">
                    <h4>API上传图片格式设置</h4>
                    <div class="radio-group">
                      <div class="radio-item">
                        <input type="radio" name="defaultFormat" value="original" id="format-original">
                        <label for="format-original">保持原始格式</label>
                      </div>
                      <div class="radio-item">
                        <input type="radio" name="defaultFormat" value="webp" id="format-webp">
                        <label for="format-webp">转为WebP</label>
                      </div>
                      <div class="radio-item">
                        <input type="radio" name="defaultFormat" value="avif" id="format-avif">
                        <label for="format-avif">转为AVIF</label>
                      </div>
                    </div>
                    <p class="form-help">此设置将应用于所有通过API上传的图片。如果API请求中未指定format参数，将使用此默认设置。</p>
                  </div>
                </div>
              </div>

              <!-- 创建新令牌 -->
              <div class="config-section">
                <div class="config-header">
                  <h3>创建新令牌</h3>
                </div>
                <div class="config-content">
                  <form id="createTokenForm">
                    <div class="form-group">
                      <label for="tokenName" class="form-label">令牌名称</label>
                      <input type="text" class="form-control" id="tokenName" placeholder="例如：PicGo客户端" required>
                      <div class="form-help">用于标识此令牌的用途</div>
                    </div>
                    <button type="submit" class="btn btn-primary">创建令牌</button>
                  </form>
                  
                  <div id="newTokenInfo" style="display: none;" class="alert alert-success">
                    <p><strong>新令牌已创建!</strong> 请保存此令牌，它只会显示一次。</p>
                    <div class="new-token-value" id="newTokenValue"></div>
                    <button class="btn btn-secondary" onclick="copyNewToken()">复制令牌</button>
                  </div>
                </div>
              </div>

              <!-- 现有令牌 -->
              <div class="config-section">
                <div class="config-header">
                  <h3>现有令牌</h3>
                </div>
                <div class="config-content">
                  <div id="tokenList" class="token-list">
                    <div id="noTokensMessage" class="no-data-message">暂无令牌</div>
                  </div>
                </div>
              </div>
            </div>

            <div class="settings-col-sidebar">
              <!-- API使用说明 -->
              <div class="config-section">
                <div class="config-header">
                  <h3>API使用说明</h3>
                </div>
                <div class="config-content">
                  <p>您可以通过API上传图片，方便与第三方工具集成。</p>
                  
                  <div class="info-box">
                    <h4>PicGo设置</h4>
                    <p>在PicGo中添加自定义图床：</p>
                    <ul>
                      <li><strong>上传地址</strong>: <code id="apiEndpoint"></code></li>
                      <li><strong>请求方式</strong>: POST</li>
                      <li><strong>自定义请求头</strong>: <code>x-api-token</code> 填入您的令牌</li>
                      <li><strong>图片上传字段名</strong>: images</li>
                      <li><strong>自定义URL部分</strong>: <code>picgo=true</code></li>
                      <li><strong>返回值字段</strong>: result</li>
                    </ul>
                  </div>

                  <h4>API端点</h4>
                  <ul>
                    <li><code>/api/upload</code> - 上传图片</li>
                    <li>可选参数 <code>format</code>: 
                      <ul>
                        <li><code>original</code> - 保持原始格式</li>
                        <li><code>webp</code> - 转换为WebP格式</li>
                        <li><code>avif</code> - 转换为AVIF格式</li>
                      </ul>
                    </li>
                  </ul>
                  
                  <h4>认证方式</h4>
                  <p>使用以下任一方式提供令牌：</p>
                  <ul>
                    <li>请求头: <code>x-api-token: 您的令牌</code></li>
                    <li>URL参数: <code>?token=您的令牌</code></li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- 存储配置部分 -->
        <section id="storage-config-section" class="settings-section">
          <div class="section-header">
            <h2>存储配置</h2>
            <p class="section-description">配置图片存储方式，选择本地存储或云端存储</p>
          </div>

          <div class="alert alert-info">
            <strong>说明：</strong>您可以选择将图片存储在本地服务器或Cloudflare R2对象存储。R2提供更好的可扩展性和CDN加速。
          </div>

          <div class="settings-row">
            <div class="settings-col-main">
              <div class="config-section">
                <div class="config-header">
                  <h3>存储方式选择</h3>
                </div>
                <div class="config-content">
                  <form id="storageConfigForm">
                    <div class="storage-option" id="local-option">
                      <input type="radio" name="storageType" value="local" id="storage-local">
                      <label for="storage-local" class="storage-label">本地存储</label>
                      <p class="storage-desc">图片存储在服务器本地文件系统中</p>
                    </div>

                    <div class="storage-option" id="r2-option">
                      <input type="radio" name="storageType" value="r2" id="storage-r2">
                      <label for="storage-r2" class="storage-label">Cloudflare R2对象存储</label>
                      <p class="storage-desc">图片存储在Cloudflare R2，提供全球CDN加速</p>

                      <div class="r2-config" id="r2-config">
                        <div class="form-group">
                          <div class="checkbox-group">
                            <input class="form-check-input" type="checkbox" id="r2EnabledSwitch">
                            <label class="form-check-label" for="r2EnabledSwitch">启用R2存储</label>
                          </div>
                        </div>

                        <div class="form-group">
                          <label class="form-label" for="r2AccessKeyId">Access Key ID</label>
                          <input type="text" class="form-control" id="r2AccessKeyId" placeholder="R2 Access Key ID">
                          <div class="form-help">在Cloudflare控制台的R2管理页面获取</div>
                        </div>

                        <div class="form-group">
                          <label class="form-label" for="r2SecretAccessKey">Secret Access Key</label>
                          <input type="password" class="form-control" id="r2SecretAccessKey" placeholder="R2 Secret Access Key">
                          <div class="form-help">对应的密钥，请妥善保管</div>
                        </div>

                        <div class="form-group">
                          <label class="form-label" for="r2Endpoint">Endpoint</label>
                          <input type="text" class="form-control" id="r2Endpoint" placeholder="https://your-account-id.r2.cloudflarestorage.com">
                          <div class="form-help">R2存储的API端点，格式：https://your-account-id.r2.cloudflarestorage.com</div>
                        </div>

                        <div class="form-group">
                          <label class="form-label" for="r2Bucket">Bucket名称</label>
                          <input type="text" class="form-control" id="r2Bucket" placeholder="my-image-bucket">
                          <div class="form-help">存储图片的Bucket名称</div>
                        </div>

                        <div class="form-group">
                          <label class="form-label" for="r2Region">区域</label>
                          <input type="text" class="form-control" id="r2Region" placeholder="auto" value="auto">
                          <div class="form-help">通常保持"auto"即可</div>
                        </div>

                        <div class="form-group">
                          <label class="form-label" for="r2CustomDomain">自定义域名 (可选)</label>
                          <input type="text" class="form-control" id="r2CustomDomain" placeholder="cdn.yourdomain.com">
                          <div class="form-help">如果您配置了自定义域名，请填写此项以获得更好的访问速度</div>
                        </div>

                        <div class="form-group">
                          <button type="button" class="btn btn-secondary" id="testR2Connection">测试R2连接</button>
                          <div id="testResult" class="test-result"></div>
                        </div>
                      </div>
                    </div>

                    <div class="action-buttons">
                      <button type="submit" class="btn btn-primary">保存配置</button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
            
            <div class="settings-col-sidebar">
              <div class="config-section">
                <div class="config-header">
                  <h3>配置说明</h3>
                </div>
                <div class="config-content">
                  <h4>本地存储</h4>
                  <ul>
                    <li>图片存储在服务器本地</li>
                    <li>无需额外配置</li>
                    <li>适合小规模使用</li>
                  </ul>

                  <h4>R2对象存储</h4>
                  <ul>
                    <li>全球CDN加速</li>
                    <li>无限扩展性</li>
                    <li>高可用性</li>
                    <li>成本优化</li>
                  </ul>

                  <div class="alert alert-warning">
                    <strong>注意：</strong>更改存储方式不会影响已上传的文件，但新上传的文件将使用新的存储方式。
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>
      </div>
    </div>
  </main>

  <script>
    // 导航相关变量
    let currentSection = 'image-quality';

    // 质量描述映射
    function getQualityDescription(value) {
      if (value >= 90) return '最高质量';
      if (value >= 80) return '高质量';
      if (value >= 70) return '中等质量';
      if (value >= 60) return '低质量';
      return '压缩优先';
    }

    // 更新质量显示
    function updateQualityDisplay(slider) {
      const value = slider.value;
      const valueSpan = document.getElementById(slider.id + 'Value');
      const descSpan = document.getElementById(slider.id + 'Desc');
      
      valueSpan.textContent = value;
      descSpan.textContent = getQualityDescription(parseInt(value));
    }

    // 质量预设配置
    const presets = {
      high: { webp: 92, avif: 85 },
      balanced: { webp: 80, avif: 75 },
      compressed: { webp: 65, avif: 60 }
    };

    // 应用预设
    function applyPreset(presetName) {
      const preset = presets[presetName];
      if (!preset) return;

      document.getElementById('webpQuality').value = preset.webp;
      document.getElementById('avifQuality').value = preset.avif;

      // 更新显示
      updateQualityDisplay(document.getElementById('webpQuality'));
      updateQualityDisplay(document.getElementById('avifQuality'));
    }

    // 恢复默认设置
    function resetToDefaults() {
      applyPreset('balanced');
      document.getElementById('pngOptimize').checked = true;
    }

    // 侧边栏导航切换
    function switchSection(sectionName) {
      // 更新导航状态
      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
      });
      document.querySelector(`[data-section="${sectionName}"]`).classList.add('active');

      // 更新内容区域
      document.querySelectorAll('.settings-section').forEach(section => {
        section.classList.remove('active');
      });
      document.getElementById(`${sectionName}-section`).classList.add('active');

      currentSection = sectionName;

      // 根据当前选择的部分加载相应数据
      if (sectionName === 'api-management') {
        fetchApiStatus();
      } else if (sectionName === 'storage-config') {
        loadStorageConfig();
      }
    }

    // 复制功能
    function copyToClipboard(text, successMessage) {
      if (!text) {
        showMessage('没有可复制的内容', 'error');
        return;
      }
      
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text)
          .then(() => showMessage(successMessage))
          .catch((err) => {
            console.error('复制失败:', err);
            fallbackCopy(text, successMessage);
          });
      } else {
        fallbackCopy(text, successMessage);
      }
    }
    
    function fallbackCopy(text, successMessage) {
      try {
        const textArea = document.createElement('textarea');
        textArea.value = text;
        textArea.style.position = 'fixed';
        textArea.style.top = '0';
        textArea.style.left = '0';
        textArea.style.opacity = '0';
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        
        const successful = document.execCommand('copy');
        if (successful) {
          showMessage(successMessage);
        } else {
          showMessage('复制失败，请手动复制', 'error');
        }
        
        document.body.removeChild(textArea);
      } catch (err) {
        console.error('备用复制方法失败:', err);
        showMessage('复制失败，请手动复制', 'error');
      }
    }

    // 复制新令牌
    window.copyNewToken = function() {
      const tokenValue = document.getElementById('newTokenValue').textContent;
      copyToClipboard(tokenValue, '令牌已复制到剪贴板');
    };

    // 复制现有令牌
    window.copyExistingToken = function(token) {
      copyToClipboard(token, '令牌已复制到剪贴板');
    };

    // API管理相关函数
    function fetchApiStatus() {
      fetch('/api/tokens')
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // 更新API开关状态
            document.getElementById('apiEnabledSwitch').checked = data.enabled;
            document.getElementById('apiDisabledWarning').style.display = data.enabled ? 'none' : 'block';
            
            // 更新默认格式选择
            const formatRadios = document.getElementsByName('defaultFormat');
            formatRadios.forEach(radio => {
              radio.checked = radio.value === data.defaultFormat;
            });
            
            // 更新令牌列表
            renderTokenList(data.tokens);
          }
        })
        .catch(error => {
          console.error('获取API状态失败:', error);
        });
    }

    function renderTokenList(tokens) {
      const tokenListElem = document.getElementById('tokenList');
      const noTokensMessage = document.getElementById('noTokensMessage');
      
      if (tokens.length === 0) {
        noTokensMessage.style.display = 'block';
        tokenListElem.innerHTML = '';
        return;
      }
      
      noTokensMessage.style.display = 'none';
      tokenListElem.innerHTML = '';
      
      tokens.forEach(token => {
        const createdDate = new Date(token.createdAt).toLocaleString();
        const expiresDate = token.expiresAt ? new Date(token.expiresAt).toLocaleString() : '永不过期';
        
        const tokenDiv = document.createElement('div');
        tokenDiv.className = 'token-item';
        tokenDiv.innerHTML = `
          <div class="token-header">
            <h4>${token.name}</h4>
            <button class="btn btn-danger btn-sm delete-token-btn" data-token-id="${token.id}">删除</button>
          </div>
          <div class="token-value" onclick="copyExistingToken('${token.token}')" title="点击复制令牌">${token.token}</div>
          <div class="token-info">
            <div>创建时间: ${createdDate}</div>
            <div>过期时间: ${expiresDate}</div>
          </div>
        `;
        
        tokenListElem.appendChild(tokenDiv);
      });

      // 添加删除按钮事件监听器
      document.querySelectorAll('.delete-token-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const tokenId = this.dataset.tokenId;
          if (confirm('确定要删除此令牌吗？此操作不可恢复。')) {
            deleteToken(tokenId);
          }
        });
      });
    }

    function createToken() {
      const tokenName = document.getElementById('tokenName').value.trim();
      
      if (!tokenName) {
        showMessage('请输入令牌名称', 'error');
        return;
      }
      
      fetch('/api/tokens', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          name: tokenName
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // 显示新创建的令牌
          document.getElementById('newTokenValue').textContent = data.token.token;
          document.getElementById('newTokenInfo').style.display = 'block';
          
          // 清空输入并重新加载令牌列表
          document.getElementById('tokenName').value = '';
          fetchApiStatus();
        } else {
          showMessage('创建令牌失败: ' + (data.message || '未知错误'), 'error');
        }
      })
      .catch(error => {
        console.error('创建令牌请求失败:', error);
        showMessage('创建令牌请求失败，请稍后再试', 'error');
      });
    }

    function toggleApiStatus() {
      fetch('/api/toggle', {
        method: 'POST'
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // 更新开关状态和警告消息
          document.getElementById('apiEnabledSwitch').checked = data.enabled;
          document.getElementById('apiDisabledWarning').style.display = data.enabled ? 'none' : 'block';
          showMessage('API状态已更新');
        } else {
          showMessage('切换API状态失败: ' + (data.message || '未知错误'), 'error');
          // 重置开关状态
          fetchApiStatus();
        }
      })
      .catch(error => {
        console.error('切换API状态请求失败:', error);
        showMessage('切换API状态请求失败，请稍后再试', 'error');
        // 重置开关状态
        fetchApiStatus();
      });
    }

    function updateDefaultFormat(format) {
      fetch('/api/format', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ format })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          showMessage('默认格式设置已更新');
        } else {
          showMessage('更新默认格式失败: ' + (data.message || '未知错误'), 'error');
          // 重置格式选择
          fetchApiStatus();
        }
      })
      .catch(error => {
        console.error('更新默认格式请求失败:', error);
        showMessage('更新默认格式请求失败，请稍后再试', 'error');
        // 重置格式选择
        fetchApiStatus();
      });
    }

    function deleteToken(tokenId) {
      fetch(`/api/tokens/${tokenId}`, {
        method: 'DELETE'
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          showMessage('令牌删除成功');
          // 重新加载令牌列表
          fetchApiStatus();
        } else {
          showMessage('删除令牌失败: ' + (data.message || '未知错误'), 'error');
        }
      })
      .catch(error => {
        console.error('删除令牌请求失败:', error);
        showMessage('删除令牌请求失败，请稍后再试', 'error');
      });
    }

    // 存储配置相关函数
    function loadStorageConfig() {
      fetch('/api/storage-config')
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            const config = data.config;
            
            // 设置存储类型
            document.querySelector(`input[value="${config.type}"]`).checked = true;
            toggleStorageOption(config.type);
            
            // 设置R2配置
            if (config.r2) {
              document.getElementById('r2EnabledSwitch').checked = config.r2.enabled;
              document.getElementById('r2Endpoint').value = config.r2.endpoint || '';
              document.getElementById('r2Bucket').value = config.r2.bucket || '';
              document.getElementById('r2Region').value = config.r2.region || 'auto';
              document.getElementById('r2CustomDomain').value = config.r2.customDomain || '';
              
              // 不显示敏感信息，只显示是否已配置
              if (config.r2.hasCredentials) {
                document.getElementById('r2AccessKeyId').placeholder = '已配置 (留空保持不变)';
                document.getElementById('r2SecretAccessKey').placeholder = '已配置 (留空保持不变)';
              }
            }
          }
        })
        .catch(error => {
          console.error('加载配置失败:', error);
        });
    }

    function toggleStorageOption(storageType) {
      // 更新视觉状态
      document.querySelectorAll('.storage-option').forEach(option => option.classList.remove('active'));
      document.getElementById(`${storageType}-option`).classList.add('active');

      // 显示/隐藏R2配置
      const r2Config = document.getElementById('r2-config');
      if (storageType === 'r2') {
        r2Config.style.display = 'block';
      } else {
        r2Config.style.display = 'none';
      }
    }

    function saveStorageConfig() {
      const formData = new FormData(document.getElementById('storageConfigForm'));
      const storageType = formData.get('storageType');
      
      const configData = {
        type: storageType,
        r2: {
          enabled: document.getElementById('r2EnabledSwitch').checked,
          endpoint: document.getElementById('r2Endpoint').value,
          bucket: document.getElementById('r2Bucket').value,
          region: document.getElementById('r2Region').value,
          customDomain: document.getElementById('r2CustomDomain').value
        }
      };
      
      // 只有在有值时才包含敏感信息
      const accessKeyId = document.getElementById('r2AccessKeyId').value;
      const secretAccessKey = document.getElementById('r2SecretAccessKey').value;
      if (accessKeyId) configData.r2.accessKeyId = accessKeyId;
      if (secretAccessKey) configData.r2.secretAccessKey = secretAccessKey;
      
      fetch('/api/storage-config', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(configData)
      })
      .then(response => response.json())
      .then(result => {
        if (result.success) {
          showMessage('配置保存成功！');
          // 重新加载配置以更新占位符
          loadStorageConfig();
        } else {
          showMessage('保存失败：' + result.message, 'error');
        }
      })
      .catch(error => {
        console.error('保存配置失败:', error);
        showMessage('保存失败，请检查网络连接', 'error');
      });
    }

    function testR2Connection() {
      const testButton = document.getElementById('testR2Connection');
      const testResult = document.getElementById('testResult');
      
      testResult.style.display = 'none';
      testButton.disabled = true;
      testButton.textContent = '测试中...';
      
      fetch('/api/test-r2', {
        method: 'POST'
      })
      .then(response => response.json())
      .then(result => {
        testResult.style.display = 'block';
        if (result.success) {
          testResult.className = 'test-result success';
          testResult.textContent = result.message;
        } else {
          testResult.className = 'test-result error';
          testResult.textContent = result.message;
        }
      })
      .catch(error => {
        testResult.style.display = 'block';
        testResult.className = 'test-result error';
        testResult.textContent = '测试失败：' + error.message;
      })
      .finally(() => {
        testButton.disabled = false;
        testButton.textContent = '测试R2连接';
      });
    }

    // 页面加载完成后初始化
    document.addEventListener('DOMContentLoaded', function() {
      // 检查认证状态
      checkAuthStatus();

      // 加载当前设置
      loadCurrentSettings();

      // 更新API端点URL
      const baseUrl = window.location.origin;
      document.getElementById('apiEndpoint').textContent = baseUrl + '/api/upload';

      // 添加侧边栏导航事件监听器
      document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', function(e) {
          e.preventDefault();
          const sectionName = this.dataset.section;
          switchSection(sectionName);
        });
      });

      // 添加质量滑块事件监听器
      const qualitySliders = document.querySelectorAll('.quality-slider');
      qualitySliders.forEach(slider => {
        slider.addEventListener('input', () => updateQualityDisplay(slider));
      });

      // 添加预设按钮事件监听器
      const presetButtons = document.querySelectorAll('.preset-btn');
      presetButtons.forEach(btn => {
        btn.addEventListener('click', function() {
          const presetCard = this.closest('.preset-card');
          const preset = presetCard.dataset.preset;
          applyPreset(preset);
        });
      });

      // 恢复默认按钮
      document.getElementById('resetDefaults').addEventListener('click', resetToDefaults);

      // 保存质量设置
      document.getElementById('qualitySettingsForm').addEventListener('submit', saveQualitySettings);

      // API管理事件监听器
      document.getElementById('createTokenForm').addEventListener('submit', function(e) {
        e.preventDefault();
        createToken();
      });
      
      document.getElementById('apiEnabledSwitch').addEventListener('change', function() {
        toggleApiStatus();
      });

      document.getElementsByName('defaultFormat').forEach(radio => {
        radio.addEventListener('change', function() {
          updateDefaultFormat(this.value);
        });
      });

      // 存储配置事件监听器
      document.querySelectorAll('input[name="storageType"]').forEach(radio => {
        radio.addEventListener('change', function() {
          toggleStorageOption(this.value);
        });
      });

      document.getElementById('storageConfigForm').addEventListener('submit', function(e) {
        e.preventDefault();
        saveStorageConfig();
      });

      document.getElementById('testR2Connection').addEventListener('click', testR2Connection);

      // 暗色模式切换按钮
      const darkModeToggle = document.getElementById('toggleDarkMode');
      darkModeToggle.addEventListener('click', function() {
        document.body.classList.toggle('dark');
        // 保存模式偏好到localStorage
        const isDark = document.body.classList.contains('dark');
        localStorage.setItem('darkMode', isDark ? 'true' : 'false');
        darkModeToggle.textContent = isDark ? '亮色模式' : '暗色模式';
      });
      
      // 页面加载时检查暗色模式
      const storedDarkMode = localStorage.getItem('darkMode');
      if (storedDarkMode === 'true') {
        document.body.classList.add('dark');
        darkModeToggle.textContent = '亮色模式';
      }
    });

    // 检查认证状态
    async function checkAuthStatus() {
      try {
        const response = await fetch('/api/auth-status');
        const data = await response.json();
        
        if (!data.isConfigured) {
          window.location.href = '/setup';
          return;
        }
        
        if (!data.isAuthenticated) {
          window.location.href = '/login';
          return;
        }
      } catch (error) {
        console.error('检查认证状态失败:', error);
        window.location.href = '/login';
      }
    }

    // 加载当前设置
    async function loadCurrentSettings() {
      try {
        const response = await fetch('/api/settings');
        if (response.ok) {
          const settings = await response.json();
          
          // 应用质量设置
          if (settings.imageQuality) {
            if (settings.imageQuality.webp !== undefined) {
              document.getElementById('webpQuality').value = settings.imageQuality.webp;
            }
            if (settings.imageQuality.avif !== undefined) {
              document.getElementById('avifQuality').value = settings.imageQuality.avif;
            }
            if (settings.imageQuality.pngOptimize !== undefined) {
              document.getElementById('pngOptimize').checked = settings.imageQuality.pngOptimize;
            }
          }

          // 更新显示
          const qualitySliders = document.querySelectorAll('.quality-slider');
          qualitySliders.forEach(slider => updateQualityDisplay(slider));
        }
      } catch (error) {
        console.error('加载设置失败:', error);
      }
    }

    // 保存质量设置
    async function saveQualitySettings(e) {
      e.preventDefault();
      
      const settings = {
        imageQuality: {
          webp: parseInt(document.getElementById('webpQuality').value),
          avif: parseInt(document.getElementById('avifQuality').value),
          pngOptimize: document.getElementById('pngOptimize').checked
        }
      };

      try {
        const response = await fetch('/api/settings', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(settings)
        });

        if (response.ok) {
          showMessage('质量设置保存成功！', 'success');
        } else {
          const error = await response.json();
          showMessage('保存失败: ' + (error.message || '未知错误'), 'error');
        }
      } catch (error) {
        console.error('保存设置失败:', error);
        showMessage('保存失败: ' + error.message, 'error');
      }
    }

    // 显示消息
    function showMessage(message, type = 'success') {
      // 创建消息元素
      const messageEl = document.createElement('div');
      messageEl.className = `message ${type}`;
      messageEl.textContent = message;
      messageEl.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 12px 20px;
        border-radius: 6px;
        color: white;
        font-weight: 500;
        z-index: 1000;
        opacity: 0;
        transform: translateX(100%);
        transition: all 0.3s ease;
        ${type === 'success' ? 'background-color: #22c55e;' : 'background-color: #ef4444;'}
      `;

      document.body.appendChild(messageEl);

      // 显示动画
      setTimeout(() => {
        messageEl.style.opacity = '1';
        messageEl.style.transform = 'translateX(0)';
      }, 100);

      // 自动隐藏
      setTimeout(() => {
        messageEl.style.opacity = '0';
        messageEl.style.transform = 'translateX(100%)';
        setTimeout(() => {
          if (document.body.contains(messageEl)) {
            document.body.removeChild(messageEl);
          }
        }, 300);
      }, 3000);
    }
  </script>

  <style>
    /* 基础样式 */
    .settings-container {
      max-width: 1400px;
    }

    .page-header {
      text-align: center;
      margin-bottom: 2rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--border-color);
    }

    .page-header h1 {
      margin: 0 0 0.5rem 0;
      color: var(--text-primary);
    }

    .subtitle {
      margin: 0;
      color: var(--text-secondary);
    }

    /* 设置页面布局 */
    .settings-layout {
      display: flex;
      gap: 2rem;
      margin-top: 2rem;
    }

    /* 侧边栏样式 */
    .settings-sidebar {
      width: 280px;
      flex-shrink: 0;
    }

    .settings-nav {
      background: var(--bg-secondary);
      border-radius: 12px;
      padding: 1rem;
      border: 1px solid var(--border-color);
      position: sticky;
      top: 2rem;
    }

    .nav-item {
      display: flex;
      align-items: center;
      padding: 0.75rem 1rem;
      margin-bottom: 0.5rem;
      border-radius: 8px;
      text-decoration: none;
      color: var(--text-secondary);
      transition: all 0.2s ease;
      cursor: pointer;
    }

    .nav-item:hover {
      background: var(--primary-light);
      color: var(--primary-color);
    }

    .nav-item.active {
      background: var(--primary-color);
      color: white;
    }

    .nav-item:last-child {
      margin-bottom: 0;
    }

    .nav-icon {
      margin-right: 0.75rem;
      font-size: 1.2rem;
    }

    /* 主要内容区域 */
    .settings-content {
      flex: 1;
      min-width: 0;
    }

    .settings-section {
      display: none;
    }

    .settings-section.active {
      display: block;
    }

    .section-header {
      margin-bottom: 2rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--border-color);
    }

    .section-header h2 {
      margin: 0 0 0.5rem 0;
      color: var(--text-primary);
    }

    .section-header h3 {
      margin: 2rem 0 0.5rem 0;
      color: var(--text-primary);
    }

    .section-description {
      margin: 0;
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    /* 配置区块样式 */
    .config-section {
      background: var(--bg-secondary);
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 2rem;
      border: 1px solid var(--border-color);
    }

    .config-header {
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--border-color);
    }

    .config-header h3 {
      margin: 0 0 0.5rem 0;
      color: var(--text-primary);
    }

    .config-content {
      margin-top: 1rem;
    }

    /* 双栏布局 */
    .settings-row {
      display: flex;
      gap: 2rem;
    }

    .settings-col-main {
      flex: 2;
      min-width: 0;
    }

    .settings-col-sidebar {
      flex: 1;
      min-width: 300px;
    }

    /* 表单样式 */
    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
      color: var(--text-primary);
    }

    .form-control {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--border-color);
      border-radius: var(--input-border-radius);
      background-color: var(--bg-primary);
      color: var(--text-color);
      transition: border-color 0.2s ease;
    }

    .form-control:focus {
      border-color: var(--primary-color);
      outline: none;
      box-shadow: 0 0 0 2px rgba(67, 97, 238, 0.2);
    }

    .form-help {
      color: var(--text-secondary);
      font-size: 0.85rem;
      margin-top: 0.25rem;
    }

    /* 质量设置样式 */
    .quality-value {
      font-weight: 600;
      color: var(--primary-color);
    }

    .quality-control {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .quality-slider {
      width: 100%;
      height: 6px;
      border-radius: 3px;
      background: var(--border-color);
      outline: none;
      -webkit-appearance: none;
    }

    .quality-slider::-webkit-slider-thumb {
      appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: var(--primary-color);
      cursor: pointer;
      border: 2px solid white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .quality-slider::-moz-range-thumb {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: var(--primary-color);
      cursor: pointer;
      border: 2px solid white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .quality-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .quality-desc {
      font-weight: 500;
      color: var(--primary-color);
    }

    .quality-hint {
      color: var(--text-secondary);
      font-size: 0.8rem;
    }

    /* 预设卡片样式 */
    .preset-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1rem;
    }

    .preset-card {
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 1rem;
      text-align: center;
    }

    .preset-card h4 {
      margin: 0 0 0.5rem 0;
      color: var(--text-primary);
    }

    .preset-desc {
      margin: 0 0 0.5rem 0;
      font-weight: 500;
      color: var(--primary-color);
      font-size: 0.9rem;
    }

    .preset-usage {
      margin: 0 0 1rem 0;
      color: var(--text-secondary);
      font-size: 0.8rem;
    }

    .preset-btn {
      width: 100%;
    }

    /* 复选框样式 */
    .checkbox-group {
      margin-top: 0.5rem;
    }

    .checkbox-label {
      display: flex;
      align-items: center;
      cursor: pointer;
      font-size: 0.9rem;
    }

    .checkbox-label input[type="checkbox"] {
      margin-right: 0.5rem;
    }

    /* 开关按钮样式 */
    .form-check-input {
      margin-right: 0.75rem;
      height: 20px;
      width: 40px;
      cursor: pointer;
      appearance: none;
      background-color: var(--gray-400);
      border-radius: 20px;
      position: relative;
      transition: background-color 0.3s;
    }

    .form-check-input:checked {
      background-color: var(--primary-color);
    }

    .form-check-input:before {
      content: '';
      position: absolute;
      height: 16px;
      width: 16px;
      left: 2px;
      bottom: 2px;
      background-color: white;
      border-radius: 50%;
      transition: transform 0.3s;
    }

    .form-check-input:checked:before {
      transform: translateX(20px);
    }

    .form-check-label {
      cursor: pointer;
      font-weight: 500;
    }

    /* API管理样式 */
    .api-switch {
      margin-bottom: 1.5rem;
      display: flex;
      align-items: center;
    }

    .format-radio-group {
      margin-top: 1rem;
      padding: 1rem;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      background-color: var(--bg-primary);
    }

    .format-radio-group h4 {
      margin: 0 0 1rem 0;
      color: var(--text-primary);
    }

    .radio-group {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .radio-item {
      display: flex;
      align-items: center;
    }

    .radio-item input[type="radio"] {
      margin-right: 0.5rem;
    }

    /* 令牌相关样式 */
    .token-list {
      margin-top: 1rem;
    }

    .token-item {
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
      background-color: var(--bg-primary);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .token-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .token-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.75rem;
    }

    .token-header h4 {
      margin: 0;
      color: var(--text-primary);
    }

    .token-value {
      background-color: var(--bg-secondary);
      padding: 0.75rem;
      border-radius: 6px;
      font-family: monospace;
      word-break: break-all;
      cursor: pointer;
      margin-bottom: 0.75rem;
      border: 1px dashed var(--border-color);
      transition: border-color 0.2s ease;
    }

    .token-value:hover {
      border-color: var(--primary-color);
    }

    .token-info {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    .new-token-value {
      background-color: var(--bg-secondary);
      border: 1px dashed var(--primary-color);
      padding: 0.75rem;
      margin: 0.75rem 0;
      font-family: monospace;
      border-radius: 6px;
      word-break: break-all;
    }

    .no-data-message {
      text-align: center;
      padding: 2rem;
      color: var(--text-secondary);
      font-style: italic;
    }

    /* 存储配置样式 */
    .storage-option {
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
      background-color: var(--bg-primary);
      transition: border-color 0.3s, background-color 0.3s;
      cursor: pointer;
    }

    .storage-option:hover {
      border-color: var(--primary-color);
    }

    .storage-option.active {
      border-color: var(--primary-color);
      background-color: var(--primary-light);
    }

    .storage-option input[type="radio"] {
      margin-right: 0.75rem;
    }

    .storage-label {
      font-weight: 500;
      font-size: 1.1rem;
    }

    .storage-desc {
      margin: 0.5rem 0 0 1.75rem;
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    .r2-config {
      margin-top: 1rem;
      padding: 1rem;
      background-color: var(--bg-secondary);
      border-radius: 8px;
      margin-left: 1.75rem;
      display: none;
    }

    .r2-config.show {
      display: block;
    }

    /* 测试结果样式 */
    .test-result {
      margin-top: 1rem;
      padding: 0.75rem;
      border-radius: 6px;
      display: none;
    }

    .test-result.success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .test-result.error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    /* 提示框样式 */
    .alert {
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1.5rem;
    }

    .alert-info {
      background-color: #d1ecf1;
      color: #0c5460;
      border: 1px solid #b6d4ea;
    }

    .alert-warning {
      background-color: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }

    .alert-success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    /* 信息框样式 */
    .info-box {
      background: var(--bg-secondary);
      padding: 1rem;
      border-radius: 8px;
      margin: 1rem 0;
      border: 1px solid var(--border-color);
    }

    .info-box h4 {
      margin: 0 0 0.75rem 0;
      color: var(--text-primary);
    }

    .info-box ul {
      margin: 0.5rem 0;
      padding-left: 1.5rem;
    }

    .info-box li {
      margin-bottom: 0.25rem;
    }

    /* 代码样式 */
    code {
      background-color: var(--bg-secondary);
      padding: 2px 6px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 0.9em;
      color: var(--primary-color);
    }

    /* 按钮样式 */
    .action-buttons {
      display: flex;
      gap: 1rem;
      justify-content: flex-end;
      margin-top: 1.5rem;
    }

    .btn-sm {
      padding: 0.25rem 0.75rem;
      font-size: 0.875rem;
    }

    .btn-danger {
      background-color: #dc3545;
      border-color: #dc3545;
      color: white;
    }

    .btn-danger:hover {
      background-color: #c82333;
      border-color: #bd2130;
    }

    /* 响应式设计 */
    @media (max-width: 1024px) {
      .settings-layout {
        flex-direction: column;
      }

      .settings-sidebar {
        width: 100%;
      }

      .settings-nav {
        position: static;
        display: flex;
        overflow-x: auto;
        padding: 0.5rem;
      }

      .nav-item {
        white-space: nowrap;
        margin-right: 0.5rem;
        margin-bottom: 0;
      }

      .settings-row {
        flex-direction: column;
      }

      .settings-col-sidebar {
        min-width: 0;
      }
    }

    @media (max-width: 768px) {
      .action-buttons {
        flex-direction: column;
      }
      
      .preset-grid {
        grid-template-columns: 1fr;
      }
      
      .quality-info {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.25rem;
      }

      .radio-group {
        flex-direction: column;
        gap: 0.5rem;
      }

      .token-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
      }
    }
  </style>
</body>
</html> 